#!/usr/bin/env python3

import time
import os
import sys
import requests
from rich.console import Console
from azure.ai.inference import ChatCompletionsClient
from azure.ai.inference.models import SystemMessage, UserMessage, AssistantMessage
from azure.core.credentials import AzureKeyCredential

# Setup
console = Console()

# Catatan Awal
console.print("[blue]\nKetik .exit untuk keluar, ketik .info untuk info, atau langsung ketik pertanyaan.\nGunakan titik di depan perintah khusus.\n[/blue]")
time.sleep(2)
os.system("clear")

# Ambil Token dari Pastebin
PASTEBIN_RAW_URL = "https://pastebin.com/raw/dxgmGgx5"  # Ganti dengan link raw pastebin kamu

try:
    token = requests.get(PASTEBIN_RAW_URL).text.strip()
    if not token or "ghp_" not in token:
        console.print("[red]Gagal ambil token! Cek link Pastebin kamu.[/red]")
        sys.exit()
except Exception as e:
    console.print(f"[red]Error ambil token: {e}[/red]")
    sys.exit()

# Konfigurasi Model
system_prompt = "Kamu adalah SATRIA, Sistem Asisten Teks, Respon, dan Interaksi Andal. Kamu mudah memahami dan mudah dipahami, kamu cerdas, pintar dan penurut. kata kata kamu tidak terlalu baku."
endpoint = "https://models.github.ai/inference"
model = "openai/gpt-4.1-mini"

# Client
client = ChatCompletionsClient(
    endpoint=endpoint,
    credential=AzureKeyCredential(token),
)

# Memori Percakapan
chat_history = [SystemMessage(system_prompt)]
log_percakapan = []

# Baca log sebelumnya
if os.path.exists(".satria_chat.txt"):
    with open(".satria_chat.txt", "r", encoding="utf-8") as file:
        lines = file.readlines()
        for line in lines:
            if line.startswith("Kamu : "):
                pesan = line.replace("Kamu : ", "").strip()
                chat_history.append(UserMessage(pesan))
                log_percakapan.append(f"Kamu : {pesan}")
            elif line.startswith("SATRIA : "):
                balasan = line.replace("SATRIA : ", "").strip()
                chat_history.append(AssistantMessage(balasan))
                log_percakapan.append(f"SATRIA : {balasan}")

# Cek argumen terminal
args = sys.argv[1:]

# Mode: Tanya 1 kali langsung keluar
if args and args[0] != "--start":
    user_input = " ".join(args)
    chat_history.append(UserMessage(user_input))

    response = client.complete(
        messages=chat_history,
        temperature=0.8,
        top_p=0.1,
        max_tokens=2048,
        model=model
    )

    reply = response.choices[0].message.content
    console.rule("[bold blue] Jawaban [/bold blue]")
    print(f"SATRIA : {reply}")
    console.rule()
    sys.exit()

# Mode Interaktif
console.rule("[bold green] S A T R I A [/bold green]")

while True:
    user_input = input("Tanya apa saja (.exit untuk keluar): ")

    if user_input.lower() in [".exit", ".quit", ".keluar"]:
        console.print("[green]Percakapan ditutup.[/green]")
        with open(".satria_chat.txt", "a", encoding="utf-8") as file:
            file.write("\n".join(log_percakapan))
            file.write("\n--- Sesi Baru ---\n")
        break

    if user_input.lower() in [".info", ".informasi"]:
        console.rule("[bold green] S A T R I A [/bold green]")
        console.print("[blue]NAMA : SATRIA (Sistem Asisten Teks, Respon, dan Interaksi Andal)[/blue]")
        console.print("[gray]> Catatan:\n  Pembuat : Dika\n  YouTube : dikaokegas\n  AI ini pakai FREE API dari GitHub[/gray]")
        console.rule()
        continue

    chat_history.append(UserMessage(user_input))
    log_percakapan.append(f"Kamu : {user_input}")

    response = client.complete(
        messages=chat_history,
        temperature=0.8,
        top_p=0.1,
        max_tokens=2048,
        model=model
    )

    reply = response.choices[0].message.content
    console.rule("[bold blue] Jawaban [/bold blue]")
    print(f"SATRIA : {reply}")
    console.rule()

    chat_history.append(AssistantMessage(reply))
    log_percakapan.append(f"SATRIA : {reply}")
